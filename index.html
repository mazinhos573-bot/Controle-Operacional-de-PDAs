<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SGP - Sistema de Gerenciamento de PDAs</title>
<!-- Ícones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { --primary: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg: #f3f4f6; --card: #ffffff; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
.container { max-width: 1200px; margin: auto; }

/* Header & Dashboard */
header { text-align: center; margin-bottom: 30px; }
h1 { color: #1e293b; margin-bottom: 5px; }
.subtitle { color: #64748b; font-size: 0.9rem; }

.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.metric-card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-left: 5px solid var(--primary); display: flex; align-items: center; justify-content: space-between; }
.metric-card.success { border-color: var(--success); }
.metric-card.danger { border-color: var(--danger); }
.metric-info h3 { margin: 0; font-size: 0.9rem; color: #64748b; }
.metric-info p { margin: 5px 0 0; font-size: 1.8rem; font-weight: bold; color: #1e293b; }
.metric-icon { font-size: 2rem; opacity: 0.2; }

/* Tabs */
.tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; }
.tab { padding: 12px 25px; border-radius: 30px; background: #e2e8f0; cursor: pointer; font-weight: 600; transition: 0.3s; border: none; color: #475569; }
.tab:hover { background: #cbd5e1; }
.tab.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

/* Cards & Forms */
.card { background: var(--card); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
.card h2 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; font-size: 1.25rem; }

.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
input, select, button { padding: 12px; border-radius: 8px; border: 1px solid #cbd5e1; width: 100%; box-sizing: border-box; font-size: 14px; transition: 0.2s; }
input:focus, select:focus { border-color: var(--primary); outline: none; ring: 2px solid var(--primary); }

.btn { cursor: pointer; border: none; font-weight: bold; color: #fff; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary { background: var(--primary); }
.btn-success { background: var(--success); }
.btn-danger { background: var(--danger); }
.btn-warning { background: var(--warning); color: #fff; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* Tables */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.95rem; }
th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; }
tr:hover { background: #f8fafc; }

/* Status Badges */
.badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
.badge-avail { background: #d1fae5; color: #065f46; }
.badge-busy { background: #fee2e2; color: #991b1b; }
.badge-done { background: #eff6ff; color: #1e40af; }

/* Utilities */
.hidden { display: none !important; }
.toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: #fff; padding: 15px 25px; border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); opacity: 0; transition: 0.3s; transform: translateY(20px); z-index: 1000; }
.toast.show { opacity: 1; transform: translateY(0); }
.chart-container { position: relative; height: 250px; width: 100%; }
.actions-cell { display: flex; gap: 5px; }
</style>
</head>
<body>

<div class="container">
    <header>
        <h1><i class="fa-solid fa-boxes-stacked"></i> Controle Operacional de PDAs</h1>
        <p class="subtitle">Gerenciamento de Estoque e Produtividade</p>
    </header>

    <!-- DASHBOARD -->
    <div class="dashboard">
        <div class="metric-card">
            <div class="metric-info">
                <h3>Total PDAs</h3>
                <p id="dashTotal">0</p>
            </div>
            <i class="fa-solid fa-mobile-screen metric-icon"></i>
        </div>
        <div class="metric-card danger">
            <div class="metric-info">
                <h3>Em Uso</h3>
                <p id="dashUso">0</p>
            </div>
            <i class="fa-solid fa-user-clock metric-icon"></i>
        </div>
        <div class="metric-card success">
            <div class="metric-info">
                <h3>Disponíveis</h3>
                <p id="dashDisp">0</p>
            </div>
            <i class="fa-solid fa-check-circle metric-icon"></i>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="abrirAba('operacional')"><i class="fa-solid fa-dolly"></i> Operações</button>
        <button class="tab" onclick="abrirAba('estoque')"><i class="fa-solid fa-warehouse"></i> Estoque & Gráficos</button>
        <button class="tab" onclick="abrirAba('historico')"><i class="fa-solid fa-clock-rotate-left"></i> Histórico</button>
    </div>

    <!-- ABA OPERACIONAL -->
    <div id="operacional" class="aba">
        <!-- Nova Operação -->
        <div class="card">
            <h2><i class="fa-solid fa-circle-play"></i> Iniciar Operação (Empréstimo)</h2>
            <div class="form-grid">
                <select id="opArea">
                    <option value="" disabled selected>Selecione a Área</option>
                    <option>Chegada</option>
                    <option>Consolidação</option>
                    <option>Expedição</option>
                </select>
                <input id="opColaborador" placeholder="Nome do Colaborador">
                <input id="opLogin" placeholder="Login / Matrícula">
                <!-- Select inteligente preenchido via JS -->
                <select id="opPdaSelect">
                    <option value="">Carregando PDAs...</option>
                </select>
                <button class="btn btn-primary" onclick="iniciarOperacao()"><i class="fa-solid fa-plus"></i> Alocar PDA</button>
            </div>
        </div>

        <!-- Tabela de PDAs em Uso -->
        <div class="card">
            <h2><i class="fa-solid fa-person-digging"></i> PDAs em Uso (Ativos)</h2>
            <div class="table-responsive">
                <table id="tabelaAtivos">
                    <thead>
                        <tr>
                            <th>PDA</th>
                            <th>Colaborador</th>
                            <th>Área</th>
                            <th>Início</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ABA ESTOQUE -->
    <div id="estoque" class="aba hidden">
        <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="card">
                <h2><i class="fa-solid fa-plus-circle"></i> Cadastrar Novo PDA</h2>
                <div class="form-grid">
                    <input id="novoPdaNome" placeholder="Ex: PDA-05, ZEBRA-01">
                    <button class="btn btn-success" onclick="adicionarAoEstoque()">Adicionar</button>
                </div>
                <div class="table-responsive">
                    <table id="tabelaEstoque">
                        <thead><tr><th>PDA</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fa-solid fa-chart-pie"></i> Status da Frota</h2>
                <div class="chart-container">
                    <canvas id="graficoStatus"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ABA HISTÓRICO -->
    <div id="historico" class="aba hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2><i class="fa-solid fa-list"></i> Histórico Completo</h2>
                <button class="btn btn-success" onclick="exportarExcel()"><i class="fa-solid fa-file-excel"></i> Exportar CSV</button>
            </div>
            <div class="table-responsive">
                <table id="tabelaHistorico">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Colaborador</th>
                            <th>Área</th>
                            <th>PDA</th>
                            <th>Produção</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- Modal para Devolução -->
<div id="toast" class="toast"></div>

<script>
// --- BANCO DE DADOS (LOCALSTORAGE) ---
let estoque = JSON.parse(localStorage.getItem("db_estoque")) || []; 
// Estrutura estoque: { id: "PDA-01", status: "livre" | "uso" }

let operacoes = JSON.parse(localStorage.getItem("db_operacoes")) || [];
// Estrutura op: { id: timestamp, pda: "", colab: "", area: "", login: "", inicio: "", fim: "", qtd: 0, status: "ativo" | "concluido" }

// --- INICIALIZAÇÃO ---
let chartInstance = null;

document.addEventListener("DOMContentLoaded", () => {
    atualizarTudo();
});

// --- FUNÇÕES DE NAVEGAÇÃO ---
function abrirAba(id){
    document.querySelectorAll(".aba").forEach(a => a.classList.add("hidden"));
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.getElementById(id).classList.remove("hidden");
    // Encontrar o botão que chamou a função (aproximação)
    const buttons = document.querySelectorAll(".tab");
    if(id === 'operacional') buttons[0].classList.add("active");
    if(id === 'estoque') buttons[1].classList.add("active");
    if(id === 'historico') buttons[2].classList.add("active");
    
    if(id === 'estoque') renderChart();
}

function toast(msg, type='info'){
    const t = document.getElementById("toast");
    t.innerHTML = msg;
    t.style.borderLeft = type === 'error' ? '5px solid #ef4444' : '5px solid #10b981';
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
}

// --- LÓGICA DE ESTOQUE ---
function adicionarAoEstoque(){
    const nome = document.getElementById("novoPdaNome").value.trim().toUpperCase();
    if(!nome) return toast("Digite o nome do PDA", 'error');
    
    if(estoque.find(e => e.id === nome)) return toast("Este PDA já existe!", 'error');

    estoque.push({ id: nome, status: 'livre' });
    salvarDados();
    document.getElementById("novoPdaNome").value = "";
    toast("PDA cadastrado com sucesso!");
    atualizarTudo();
}

function removerDoEstoque(id){
    if(!confirm(`Tem certeza que deseja remover o ${id}?`)) return;
    
    // Verifica se está em uso
    const emUso = estoque.find(e => e.id === id && e.status === 'uso');
    if(emUso) return toast("Não pode remover um PDA em uso!", 'error');

    estoque = estoque.filter(e => e.id !== id);
    salvarDados();
    toast("PDA removido.");
    atualizarTudo();
}

// --- LÓGICA OPERACIONAL (Check-in/Check-out) ---
function atualizarSelectPDAs(){
    const select = document.getElementById("opPdaSelect");
    select.innerHTML = '<option value="" disabled selected>Selecione um PDA Disponível</option>';
    
    const disponiveis = estoque.filter(e => e.status === 'livre');
    if(disponiveis.length === 0){
        const opt = document.createElement("option");
        opt.text = "Sem PDAs disponíveis";
        select.add(opt);
        return;
    }

    disponiveis.forEach(pda => {
        const opt = document.createElement("option");
        opt.value = pda.id;
        opt.text = `✅ ${pda.id}`;
        select.add(opt);
    });
}

function iniciarOperacao(){
    const area = document.getElementById("opArea").value;
    const colab = document.getElementById("opColaborador").value.trim();
    const login = document.getElementById("opLogin").value.trim();
    const pda = document.getElementById("opPdaSelect").value;

    if(!area || !colab || !login || !pda) return toast("Preencha todos os campos!", 'error');

    // 1. Criar registro de operação
    const novaOp = {
        id: Date.now(),
        pda: pda,
        colab: colab,
        area: area,
        login: login,
        inicio: new Date().toLocaleString(),
        fim: null,
        qtd: 0,
        status: 'ativo'
    };
    operacoes.push(novaOp);

    // 2. Atualizar status do PDA no estoque
    const idx = estoque.findIndex(e => e.id === pda);
    if(idx > -1) estoque[idx].status = 'uso';

    salvarDados();
    
    // Limpar campos
    document.getElementById("opColaborador").value = "";
    document.getElementById("opLogin").value = "";
    document.getElementById("opPdaSelect").value = "";
    
    toast("PDA Alocado com sucesso!");
    atualizarTudo();
}

function devolverPDA(idOp){
    const qtdStr = prompt("Informe a Quantidade Produzida (ou deixe 0):");
    if(qtdStr === null) return; // Cancelou
    
    const qtd = parseInt(qtdStr) || 0;

    // 1. Encontrar operação e fechar
    const opIndex = operacoes.findIndex(o => o.id === idOp);
    if(opIndex === -1) return;

    operacoes[opIndex].status = 'concluido';
    operacoes[opIndex].fim = new Date().toLocaleString();
    operacoes[opIndex].qtd = qtd;

    // 2. Liberar PDA no estoque
    const pdaId = operacoes[opIndex].pda;
    const estIndex = estoque.findIndex(e => e.id === pdaId);
    if(estIndex > -1) estoque[estIndex].status = 'livre';

    salvarDados();
    toast(`Devolução registrada! Produção: ${qtd}`);
    atualizarTudo();
}

// --- RENDERIZAÇÃO ---
function atualizarTudo(){
    salvarDados(); // Garante sync
    atualizarDashboard();
    atualizarSelectPDAs();
    renderTabelaAtivos();
    renderTabelaEstoque();
    renderTabelaHistorico();
}

function atualizarDashboard(){
    document.getElementById("dashTotal").innerText = estoque.length;
    const emUso = estoque.filter(e => e.status === 'uso').length;
    document.getElementById("dashUso").innerText = emUso;
    document.getElementById("dashDisp").innerText = estoque.length - emUso;
}

function renderTabelaAtivos(){
    const tbody = document.querySelector("#tabelaAtivos tbody");
    tbody.innerHTML = "";
    
    const ativos = operacoes.filter(o => o.status === 'ativo');

    if(ativos.length === 0){
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Nenhuma operação ativa.</td></tr>";
        return;
    }

    ativos.forEach(op => {
        tbody.innerHTML += `
        <tr>
            <td><strong>${op.pda}</strong></td>
            <td>${op.colab} <br><small style="color:#666">${op.login}</small></td>
            <td>${op.area}</td>
            <td>${op.inicio}</td>
            <td>
                <button class="btn btn-warning" style="padding:5px 10px; font-size:12px" onclick="devolverPDA(${op.id})">
                    <i class="fa-solid fa-rotate-left"></i> Devolver
                </button>
            </td>
        </tr>`;
    });
}

function renderTabelaEstoque(){
    const tbody = document.querySelector("#tabelaEstoque tbody");
    tbody.innerHTML = "";
    
    estoque.forEach(item => {
        const badgeClass = item.status === 'livre' ? 'badge-avail' : 'badge-busy';
        const statusText = item.status === 'livre' ? 'Disponível' : 'Em Uso';
        const btnDelete = item.status === 'livre' 
            ? `<button class="btn btn-danger" style="padding:5px; font-size:12px" onclick="removerDoEstoque('${item.id}')"><i class="fa fa-trash"></i></button>` 
            : `<span style="color:#ccc"><i class="fa fa-lock"></i></span>`;

        tbody.innerHTML += `
        <tr>
            <td>${item.id}</td>
            <td><span class="badge ${badgeClass}">${statusText}</span></td>
            <td>${btnDelete}</td>
        </tr>`;
    });
}

function renderTabelaHistorico(){
    const tbody = document.querySelector("#tabelaHistorico tbody");
    tbody.innerHTML = "";
    
    // Mostrar as últimas 50 operações, invertidas (mais recentes primeiro)
    const historico = operacoes.filter(o => o.status === 'concluido').reverse().slice(0, 50);

    historico.forEach(op => {
        tbody.innerHTML += `
        <tr>
            <td><small>${op.fim}</small></td>
            <td>${op.colab}</td>
            <td>${op.area}</td>
            <td>${op.pda}</td>
            <td style="font-weight:bold; color:var(--primary)">${op.qtd}</td>
            <td><span class="badge badge-done">Concluído</span></td>
        </tr>`;
    });
}

function renderChart(){
    const ctx = document.getElementById('graficoStatus').getContext('2d');
    const livres = estoque.filter(e => e.status === 'livre').length;
    const uso = estoque.filter(e => e.status === 'uso').length;

    if(chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Disponíveis', 'Em Uso'],
            datasets: [{
                data: [livres, uso],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function exportarExcel(){
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Data Saida;Data Volta;Colaborador;Login;Area;PDA;Producao;Status\n";

    operacoes.forEach(op => {
        const row = `${op.inicio};${op.fim || ''};${op.colab};${op.login};${op.area};${op.pda};${op.qtd};${op.status}`;
        csvContent += row + "\r\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "historico_pda.csv");
    document.body.appendChild(link);
    link.click();
}

function salvarDados(){
    localStorage.setItem("db_estoque", JSON.stringify(estoque));
    localStorage.setItem("db_operacoes", JSON.stringify(operacoes));
}
</script>

</body>
</html>


